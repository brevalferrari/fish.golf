function gridCellDimensions() {
  const element = document.createElement("div");
  element.style.position = "fixed";
  element.style.height = "var(--line-height)";
  element.style.width = "1ch";
  document.body.appendChild(element);
  const rect = element.getBoundingClientRect();
  document.body.removeChild(element);
  return { width: rect.width, height: rect.height };
}

// Add padding to each media to maintain grid.
function adjustMediaPadding() {
  const cell = gridCellDimensions();

  function setHeightFromRatio(media, ratio) {
    const rect = media.getBoundingClientRect();
    const realHeight = rect.width / ratio;
    const diff = cell.height - (realHeight % cell.height);
    media.style.setProperty("padding-bottom", `${diff}px`);
  }

  function setFallbackHeight(media) {
    const rect = media.getBoundingClientRect();
    const height = Math.round(rect.width / 2 / cell.height) * cell.height;
    media.style.setProperty("height", `${height}px`);
  }

  function onMediaLoaded(media) {
    var width, height;
    switch (media.tagName) {
      case "IMG":
        width = media.naturalWidth;
        height = media.naturalHeight;
        break;
      case "VIDEO":
        width = media.videoWidth;
        height = media.videoHeight;
        break;
    }
    if (width > 0 && height > 0) {
      setHeightFromRatio(media, width / height);
    } else {
      setFallbackHeight(media);
    }
  }

  const medias = document.querySelectorAll("img, video");
  for (media of medias) {
    switch (media.tagName) {
      case "IMG":
        if (media.complete) {
          onMediaLoaded(media);
        } else {
          media.addEventListener("load", () => onMediaLoaded(media));
          media.addEventListener("error", function () {
            setFallbackHeight(media);
          });
        }
        break;
      case "VIDEO":
        switch (media.readyState) {
          case HTMLMediaElement.HAVE_CURRENT_DATA:
          case HTMLMediaElement.HAVE_FUTURE_DATA:
          case HTMLMediaElement.HAVE_ENOUGH_DATA:
            onMediaLoaded(media);
            break;
          default:
            media.addEventListener("loadeddata", () => onMediaLoaded(media));
            media.addEventListener("error", function () {
              setFallbackHeight(media);
            });
            break;
        }
        break;
    }
  }
}

adjustMediaPadding();
window.addEventListener("load", adjustMediaPadding);
window.addEventListener("resize", adjustMediaPadding);

function checkOffsets() {
  const ignoredTagNames = new Set([
    "THEAD",
    "TBODY",
    "TFOOT",
    "TR",
    "TD",
    "TH",
  ]);
  const cell = gridCellDimensions();
  const elements = document.querySelectorAll(
    "body :not(.debug-grid, .debug-toggle)",
  );
  for (const element of elements) {
    if (ignoredTagNames.has(element.tagName)) {
      continue;
    }
    const rect = element.getBoundingClientRect();
    if (rect.width === 0 && rect.height === 0) {
      continue;
    }
    const top = rect.top + window.scrollY;
    const left = rect.left + window.scrollX;
    const offset = top % (cell.height / 2);
    if (offset > 0) {
      element.classList.add("off-grid");
      console.error(
        "Incorrect vertical offset for",
        element,
        "with remainder",
        top % cell.height,
        "when expecting divisible by",
        cell.height / 2,
      );
    } else {
      element.classList.remove("off-grid");
    }
  }
}

const take_chair = () => {
  const frog = document.getElementById("frog");
  frog.onclick = put_it_back;
  frog.src =
    "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACo0lEQVRYR+2W23LbMAxEebGn//+7rUj0LEDONB5LlNJo8hJ5Els3AljsLpjTNx/5m+On/0sgF9v67/QrP9PWW8qlXF5v+YJxlFxTs5Yq67fWU601dQKWXJJlljCjkpyMs6uIHr5gvVupBLGUKk821i9E6JULHLXrWoTk2VsQ8AIpzSvNCsa/QrUe2NOPc4DSY1+LQFRm9iglNZam5ZSvYFG150ZC2WiJ/Uk538ABjwH+UCAC8onAkYJQ8SR0Lb4uHcsXoIGJfLMFCjxbEdTzwEHKO1RQCefwj0DCwH8X3REe6ocl8XKA9NUIoAQ4UCFh82BCIIDzdnDd05AKbuIABOv2RPOobhJhJBCn4QGe0LKlr/CceyGPmp3+Q5f6HjI04t7GAZc4og9+6c+tKJjojBzNGElUuHEFiSUCgr844dyPZAbkgO/DuCJefDAF+QZqqI/U27nZsEzA60OK5cmjmFCkEfJzTmBOeZBDbkiqTtbCxy1b/n1wLBPoGIGGj9ux4Kf0CC/9SwXcI4MJhLuRlCGJnpgPhwloEkpZIOCL0gl+x+LT9uGn/9Y10QSsBjbhWCt3XMBTiL25vumC+0GoXuUPHAYJg5CGGkhWRHQO+Cg7PI4R0Dgm6Jxy3o7y4FymI+l1V0dnj1BoU+sbKGhwR4cgMHsIH+e7cXZvOPzacLzsdETIaMuJ+c/4XCGxnxnNVYVU+uEZzb9GZaC7hFdtewihzyDwrnEK3pnL7P3mTFq1WG1Cwjwv8bw5llX8+840JZnM+dHLzASxVyTnupcSkMrmi2e3XxvhNcj27PlSAlQSO+Qrmw+fJfuEvZSAEGBngCPL+c6NXmaFsZe4LsM3fJEy1XvX/15Pl6x8eeA0Ag6/gg/TOYvAKqHTCawW+uz9nwT+AvOhfDACXuk4AAAAAElFTkSuQmCC";
  var link = document.createElement("link");
  link.setAttribute("rel", "stylesheet");
  link.setAttribute("type", "text/css");
  link.setAttribute("href", "froggie.css");
  document.head.appendChild(link);
};

const put_it_back = () => {
  var elements = document.querySelectorAll('link[href="froggie.css"]');
  for (var i = 0; i < elements.length; i++) {
    elements[i].parentNode.removeChild(elements[i]);
  }
  const frog = document.getElementById("frog");
  frog.src =
    "data:image/x-icon;base64,AAACAAEAICAAAAAAAACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQIom/0GKJv9AiSX/P4gl/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAiib/P4kl/0CJJf8/iSX/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsWB0A/iiX/P4ol/z+JJP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQYon/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD+KJf9AiiX/P4kk/wAAAAAAAAAAAAAAAAAA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";
  frog.onclick = take_chair;
};

var pat_counter = 0;

const pat = () => {
  if (++pat_counter == 3) {
    me = document.getElementById("me");
    me.innerHTML = "thanks! :D";
  }
};

const debugToggle = document.querySelector(".debug-toggle");
function onDebugToggle() {
  document.body.classList.toggle("debug", debugToggle.checked);
}
debugToggle.addEventListener("change", onDebugToggle);
onDebugToggle();
